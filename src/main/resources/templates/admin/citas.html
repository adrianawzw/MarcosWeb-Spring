<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Citas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

<div class="max-w-6xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
    <h1 class="text-3xl font-bold mb-6 text-blue-700 text-center">Gestión de Citas</h1>

    <!-- Buscador -->
    <form th:action="@{/admin/citas}" method="get" class="flex flex-col sm:flex-row mb-6 gap-2">
        <input type="text" name="buscar" th:value="${buscar}" placeholder="Buscar por fecha (YYYY-MM-DD)"
               class="flex-grow p-2 border rounded-md focus:outline-none w-full sm:w-auto">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 w-full sm:w-auto">
            Buscar
        </button>
    </form>

    <!-- Botón nueva cita -->
    <div class="flex justify-end mb-4">
        <button onclick="openModal()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
            Nueva Cita
        </button>
    </div>

    <!-- Tabla -->
    <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="min-w-full border-collapse">
            <thead>
            <tr class="bg-blue-100 text-left text-sm sm:text-base">
                <th class="p-2">ID</th>
                <th class="p-2">Paciente</th>
                <th class="p-2">Odontólogo</th>
                <th class="p-2">Consultorio</th>
                <th class="p-2">Servicio</th>
                <th class="p-2">Fecha</th>
                <th class="p-2">Hora Inicio</th>
                <th class="p-2">Hora Fin</th>
                <th class="p-2">Estado</th>
                <th class="p-2">Acciones</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="cita : ${citas}" class="border-t hover:bg-gray-50 text-sm sm:text-base">
                <td th:text="${cita.idCita}" class="p-2"></td>
                <td th:text="${cita.paciente != null ? cita.paciente.usuario.nombre + ' ' + cita.paciente.usuario.apellido : 'Sin paciente'}" class="p-2"></td>
                <td th:text="${cita.odontologo != null ? cita.odontologo.usuario.nombre + ' ' + cita.odontologo.usuario.apellido : 'Sin odontólogo'}" class="p-2"></td>
                <td th:text="${cita.consultorio != null ? cita.consultorio.nombre : 'Sin consultorio'}" class="p-2"></td>
                <td th:text="${cita.servicio != null ? cita.servicio.nombre : 'Sin servicio'}" class="p-2"></td>
                <td th:text="${cita.fecha}" class="p-2"></td>
                <td th:text="${cita.horaInicio}" class="p-2"></td>
                <td th:text="${cita.horaFin}" class="p-2"></td>
                <td th:text="${cita.estado}" class="p-2 capitalize"></td>
                <td class="p-2 space-x-2">
                    <button type="button"
                            th:onclick="'editCita(' + ${cita.idCita} + ')' "
                            class="text-blue-600 hover:underline">
                        Editar
                    </button>
                    <a th:href="@{'/admin/citas/eliminar/' + ${cita.idCita}}"
                       class="text-red-600 hover:underline"
                       onclick="return confirm('¿Eliminar cita?')">Eliminar</a>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Nueva / Editar -->
<!-- Modal Nueva / Editar -->
<div id="modalCita" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-11/12 sm:w-3/4 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto relative p-6 animate-fadeIn">
        <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-lg font-bold">✖</button>

        <h2 class="text-2xl font-bold mb-4 text-blue-700 text-center"
            th:text="${editar} ? 'Editar Cita' : 'Nueva Cita'">Nueva Cita</h2>

        <form th:action="@{/admin/citas/guardar}" th:object="${cita}" method="post" class="space-y-4">
            <!-- ID oculto -->
            <input type="hidden" th:field="*{idCita}" />

            <!-- ODONTÓLOGO -->
            <div>
                <label class="block text-gray-700 text-sm font-medium">Odontólogo:</label>
                <select th:field="*{odontologo.idOdontologo}" class="border p-2 w-full rounded-md" required>
                    <option value="">Seleccionar Odontólogo</option>
                    <option th:each="o : ${odontologos}"
                            th:value="${o.idOdontologo}"
                            th:text="${o.usuario.nombre + ' ' + o.usuario.apellido}">
                    </option>
                </select>
            </div>

            <!-- CONSULTORIO -->
            <div>
                <label class="block text-gray-700 text-sm font-medium">Consultorio:</label>
                <select th:field="*{consultorio.idConsultorio}" class="border p-2 w-full rounded-md" required>
                    <option value="">Seleccionar Consultorio</option>
                    <option th:each="c : ${consultorios}"
                            th:value="${c.idConsultorio}"
                            th:text="${c.nombre}">
                    </option>
                </select>
            </div>

            <!-- SERVICIO -->
            <div>
                <label class="block text-gray-700 text-sm font-medium">Servicio:</label>
                <select th:field="*{servicio.idServicio}" class="border p-2 w-full rounded-md" required>
                    <option value="">Seleccionar Servicio</option>
                    <option th:each="s : ${servicios}"
                            th:value="${s.idServicio}"
                            th:text="${s.nombre}">
                    </option>
                </select>
            </div>

            <!-- FECHA -->
            <div>
                <label class="block text-gray-700 text-sm font-medium">Fecha:</label>
                <input type="date"
                       th:field="*{fecha}"
                       th:value="${#temporals.format(cita.fecha, 'yyyy-MM-dd')}"
                       class="border p-2 w-full rounded-md" required />
            </div>

            <!-- HORAS -->
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-medium">Hora Inicio:</label>
                    <input type="time"
                           th:field="*{horaInicio}"
                           th:value="${#temporals.format(cita.horaInicio, 'HH:mm')}"
                           class="border p-2 w-full rounded-md" required />
                </div>
                <div class="flex-1">
                    <label class="block text-gray-700 text-sm font-medium">Hora Fin:</label>
                    <input type="time"
                           th:field="*{horaFin}"
                           th:value="${#temporals.format(cita.horaFin, 'HH:mm')}"
                           class="border p-2 w-full rounded-md" required />
                </div>
            </div>

            <!-- ESTADO -->
            <div>
                <label class="block text-gray-700 text-sm font-medium">Estado:</label>
                <select th:field="*{estado}" class="border p-2 w-full rounded-md">
                    <option value="pendiente">Pendiente</option>
                    <option value="confirmada">Confirmada</option>
                    <option value="cancelada">Cancelada</option>
                </select>
            </div>

            <!-- OBSERVACIONES -->
            <div>
                <label class="block text-gray-700 text-sm font-medium">Observaciones:</label>
                <textarea th:field="*{observaciones}" class="border p-2 w-full rounded-md" rows="3"></textarea>
            </div>

            <!-- BOTONES -->
            <div class="flex justify-end mt-4">
                <button type="button" onclick="closeModal()"
                        class="bg-gray-500 text-white px-4 py-2 rounded-md mr-2 hover:bg-gray-600">
                    Cancelar
                </button>
                <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                        th:text="${editar} ? 'Actualizar' : 'Guardar'">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>


<!-- Animación -->
<style>
@keyframes fadeIn {
    from {opacity: 0; transform: scale(0.9);}
    to {opacity: 1; transform: scale(1);}
}
.animate-fadeIn { animation: fadeIn 0.2s ease-out; }
</style>

<script>
function openModal() {
    document.getElementById("modalCita").classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
}
function closeModal() {
    document.getElementById("modalCita").classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
}
function editCita(idCita) {
    window.location.href = `/admin/citas/editar/${idCita}`;
}
</script>

<!-- Abrir modal automáticamente si está en modo edición -->
<script th:inline="javascript">
/*<![CDATA[*/
let isEditMode = /*[[${editar}]]*/ false;
if (isEditMode) {
    openModal();
}
/*]]>*/
</script>

</body>
</html>
