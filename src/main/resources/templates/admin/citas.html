<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Gesti√≥n de Citas | Vida Plena</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn { animation: fadeIn 0.5s ease-in-out; }
    .glass {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.4);
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 via-blue-100 to-indigo-100 font-['Inter',sans-serif]">

  <div class="max-w-7xl mx-auto py-10 px-6 animate-fadeIn">

    <!-- Encabezado -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8">
      <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-700 via-indigo-600 to-cyan-500 mb-4 md:mb-0">
        Gesti√≥n de Citas üóìÔ∏è
      </h1>
      <div class="flex gap-3">
        <a href="/dashboard" class="px-4 py-2 bg-gray-500 text-white rounded-xl shadow hover:bg-gray-600 transition flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
               viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
          </svg>
          Volver
        </a>
        <button onclick="openModal()" class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-400 text-white rounded-xl shadow hover:scale-105 transition">
          + Nueva Cita
        </button>
      </div>
    </div>

    <!-- Buscador -->
    <form th:action="@{/admin/citas}" method="get" class="flex flex-col sm:flex-row gap-3 mb-6">
      <input type="text" name="buscar" th:value="${buscar}" placeholder="Buscar por fecha (YYYY-MM-DD)"
             class="flex-1 p-3 rounded-xl border border-gray-300 bg-white/80 focus:outline-none focus:ring-2 focus:ring-blue-300">
      <button type="submit" class="px-5 py-2 bg-blue-600 text-white rounded-xl shadow hover:bg-blue-700 transition">
        Buscar
      </button>
    </form>

    <!-- Tabla -->
    <div class="overflow-x-auto glass rounded-2xl shadow-xl">
      <table class="w-full text-center border-collapse">
        <thead class="bg-gradient-to-r from-blue-600 to-indigo-500 text-white text-sm uppercase tracking-wide">
          <tr>
            <th class="py-3 px-2">ID</th>
            <th class="py-3 px-2">Paciente</th>
            <th class="py-3 px-2">Odont√≥logo</th>
            <th class="py-3 px-2">Consultorio</th>
            <th class="py-3 px-2">Servicio</th>
            <th class="py-3 px-2">Fecha</th>
            <th class="py-3 px-2">Inicio</th>
            <th class="py-3 px-2">Fin</th>
            <th class="py-3 px-2">Estado</th>
            <th class="py-3 px-2">Acciones</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 text-sm md:text-base">
          <tr th:each="cita : ${citas}" class="hover:bg-blue-50 transition">
            <td th:text="${cita.idCita}" class="py-2"></td>
            <td th:text="${cita.paciente != null ? cita.paciente.usuario.nombre + ' ' + cita.paciente.usuario.apellido : 'Sin paciente'}" class="py-2"></td>
            <td th:text="${cita.odontologo != null ? cita.odontologo.usuario.nombre + ' ' + cita.odontologo.usuario.apellido : 'Sin odont√≥logo'}" class="py-2"></td>
            <td th:text="${cita.consultorio != null ? cita.consultorio.nombre : 'Sin consultorio'}" class="py-2"></td>
            <td th:text="${cita.servicio != null ? cita.servicio.nombre : 'Sin servicio'}" class="py-2"></td>
            <td th:text="${cita.fecha}" class="py-2"></td>
            <td th:text="${cita.horaInicio}" class="py-2"></td>
            <td th:text="${cita.horaFin}" class="py-2"></td>
            <td th:text="${cita.estado}" class="py-2 capitalize"></td>
            <td class="py-2 flex justify-center gap-3">
              <button type="button"
                      th:onclick="'editCita(' + ${cita.idCita} + ')'"
                      class="px-3 py-1 bg-yellow-400 text-white rounded-lg hover:bg-yellow-500 transition">
                ‚úèÔ∏è
              </button>
              <a th:href="@{'/admin/citas/eliminar/' + ${cita.idCita}}"
                 onclick="return confirm('¬øEliminar cita?')"
                 class="px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition">
                üóëÔ∏è
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalCita" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
    <div class="bg-white rounded-2xl shadow-2xl w-11/12 sm:w-3/4 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto relative p-6 animate-fadeIn">
      <button onclick="closeModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-lg font-bold">‚úñ</button>

      <h2 class="text-2xl font-bold mb-5 text-transparent bg-clip-text bg-gradient-to-r from-blue-700 via-indigo-600 to-cyan-500 text-center"
          th:text="${editar} ? 'Editar Cita' : 'Nueva Cita'">Nueva Cita</h2>

      <form th:action="@{/admin/citas/guardar}" th:object="${cita}" method="post" class="space-y-4">
        <input type="hidden" th:field="*{idCita}" />

        <!-- Campos -->
        <div>
          <label class="block text-gray-700 text-sm font-medium">Odont√≥logo:</label>
          <select th:field="*{odontologo.idOdontologo}" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-blue-300" required>
            <option value="">Seleccionar Odont√≥logo</option>
            <option th:each="o : ${odontologos}" th:value="${o.idOdontologo}" th:text="${o.usuario.nombre + ' ' + o.usuario.apellido}"></option>
          </select>
        </div>

        <div>
          <label class="block text-gray-700 text-sm font-medium">Consultorio:</label>
          <select th:field="*{consultorio.idConsultorio}" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-blue-300" required>
            <option value="">Seleccionar Consultorio</option>
            <option th:each="c : ${consultorios}" th:value="${c.idConsultorio}" th:text="${c.nombre}"></option>
          </select>
        </div>

        <div>
          <label class="block text-gray-700 text-sm font-medium">Servicio:</label>
          <select th:field="*{servicio.idServicio}" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-blue-300" required>
            <option value="">Seleccionar Servicio</option>
            <option th:each="s : ${servicios}" th:value="${s.idServicio}" th:text="${s.nombre}"></option>
          </select>
        </div>

        <div class="flex flex-col sm:flex-row gap-4">
          <div class="flex-1">
            <label class="block text-gray-700 text-sm font-medium">Fecha:</label>
            <input type="date" th:field="*{fecha}" th:value="${#temporals.format(cita.fecha, 'yyyy-MM-dd')}"
                   class="border p-2 w-full rounded-md focus:ring-2 focus:ring-blue-300" required>
          </div>
          <div class="flex-1">
            <label class="block text-gray-700 text-sm font-medium">Hora Inicio:</label>
            <input type="time" th:field="*{horaInicio}" th:value="${#temporals.format(cita.horaInicio, 'HH:mm')}"
                   class="border p-2 w-full rounded-md focus:ring-2 focus:ring-blue-300" required>
          </div>
          <div class="flex-1">
            <label class="block text-gray-700 text-sm font-medium">Hora Fin:</label>
            <input type="time" th:field="*{horaFin}" th:value="${#temporals.format(cita.horaFin, 'HH:mm')}"
                   class="border p-2 w-full rounded-md focus:ring-2 focus:ring-blue-300" required>
          </div>
        </div>

        <div>
          <label class="block text-gray-700 text-sm font-medium">Estado:</label>
          <select th:field="*{estado}" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-blue-300">
            <option value="pendiente">Pendiente</option>
            <option value="confirmada">Confirmada</option>
            <option value="cancelada">Cancelada</option>
          </select>
        </div>

        <div>
          <label class="block text-gray-700 text-sm font-medium">Observaciones:</label>
          <textarea th:field="*{observaciones}" class="border p-2 w-full rounded-md focus:ring-2 focus:ring-blue-300" rows="3"></textarea>
        </div>

        <div class="flex justify-end mt-5">
          <button type="button" onclick="closeModal()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500 transition mr-2">Cancelar</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                  th:text="${editar} ? 'Actualizar' : 'Guardar'">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function openModal() {
      document.getElementById("modalCita").classList.remove("hidden");
      document.body.classList.add("overflow-hidden");
    }
    function closeModal() {
      document.getElementById("modalCita").classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }
    function editCita(idCita) {
      window.location.href = `/admin/citas/editar/${idCita}`;
    }
  </script>

  <script th:inline="javascript">
  /*<![CDATA[*/
  let isEditMode = /*[[${editar}]]*/ false;
  if (isEditMode) { openModal(); }
  /*]]>*/
  </script>

</body>
</html>
