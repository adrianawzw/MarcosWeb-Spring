<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Odontólogos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
    <h2 class="mb-3 text-center">Gestión de Odontólogos</h2>

    <div class="text-end mb-3">
        <button class="btn btn-primary" onclick="abrirModalNuevo()">Registrar Odontólogo</button>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
        <tr>
            <th>ID</th>
            <th>Nombre Completo</th>
            <th>Especialidad</th>
            <th>Teléfono</th>
            <th>Correo</th>
            <th>Nro Colegiatura</th>
            <th>Teléfono Consulta</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="odontologo : ${odontologos}">
            <td th:text="${odontologo.idOdontologo}"></td>
            <td th:text="${odontologo.usuario.nombre + ' ' + odontologo.usuario.apellido}"></td>
            <td th:text="${odontologo.especialidad}"></td>
            <td th:text="${odontologo.usuario.telefono}"></td>
            <td th:text="${odontologo.usuario.correo}"></td>
            <td th:text="${odontologo.nroColegiatura}"></td>
            <td th:text="${odontologo.telefonoConsulta}"></td>
            <td>
				<button type="button"
				        class="btn btn-warning btn-sm"
				        th:onclick="'editarOdontologo(' + ${odontologo.idOdontologo} + ')'">
				  Editar
				</button>

                <a th:href="@{/admin/odontologos/eliminar/{id}(id=${odontologo.idOdontologo})}" class="btn btn-danger btn-sm"
                   onclick="return confirm('¿Seguro que deseas eliminar este odontólogo?')">Eliminar</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Modal -->
<div class="modal fade" id="odontologoModal" tabindex="-1" aria-labelledby="odontologoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="formOdontologo" th:action="@{/admin/odontologos/guardar}" method="post">
                <input type="hidden" id="idOdontologo" name="idOdontologo">

                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="odontologoModalLabel">Registrar Odontólogo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Nombre</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Apellido</label>
                            <input type="text" class="form-control" id="apellido" name="apellido" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>DNI</label>
                            <input type="text" class="form-control" id="dni" name="dni" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Correo</label>
                            <input type="email" class="form-control" id="correo" name="correo" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Teléfono</label>
                            <input type="text" class="form-control" id="telefono" name="telefono">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Dirección</label>
                            <input type="text" class="form-control" id="direccion" name="direccion">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Contraseña</label>
                            <input type="password" class="form-control" id="password" name="password">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Especialidad</label>
                            <input type="text" class="form-control" id="especialidad" name="especialidad" required>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label>Nro Colegiatura</label>
                            <input type="text" class="form-control" id="nroColegiatura" name="nroColegiatura">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label>Teléfono Consulta</label>
                            <input type="text" class="form-control" id="telefonoConsulta" name="telefonoConsulta">
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const modal = new bootstrap.Modal(document.getElementById('odontologoModal'));
    const form = document.getElementById('formOdontologo');
    const titulo = document.getElementById('odontologoModalLabel');

    function abrirModalNuevo() {
        form.reset();
        document.getElementById("idOdontologo").value = '';
        titulo.textContent = "Registrar Odontólogo";
        form.action = "/admin/odontologos/guardar";
        modal.show();
    }

	  async function editarOdontologo(id) {
	    try {
	      // Llamamos a la API para obtener los datos del odontólogo
	      const response = await fetch(`/admin/odontologos/api/${id}`);
	      if (!response.ok) throw new Error('Error al obtener odontólogo');

	      const odontologo = await response.json();

	      // Cargar los valores en los inputs del modal
	      document.querySelector('[name="nombre"]').value = odontologo.usuario.nombre || '';
	      document.querySelector('[name="apellido"]').value = odontologo.usuario.apellido || '';
	      document.querySelector('[name="dni"]').value = odontologo.usuario.dni || '';
	      document.querySelector('[name="correo"]').value = odontologo.usuario.correo || '';
	      document.querySelector('[name="telefono"]').value = odontologo.usuario.telefono || '';
	      document.querySelector('[name="direccion"]').value = odontologo.usuario.direccion || '';
	      document.querySelector('[name="especialidad"]').value = odontologo.especialidad || '';
	      document.querySelector('[name="nroColegiatura"]').value = odontologo.nroColegiatura || '';
	      document.querySelector('[name="telefonoConsulta"]').value = odontologo.telefonoConsulta || '';

	      // Cambiar acción del formulario para actualizar
	      const form = document.querySelector('#odontologoModal form');
	      form.action = `/admin/odontologos/editar/${id}`;

	      // Ocultamos el campo de contraseña al editar
	      const passwordField = document.querySelector('#password');
	      if (passwordField) {
	        passwordField.closest('.mb-3').style.display = 'none';
	      }

	      // Abrimos el modal
	      const modal = new bootstrap.Modal(document.getElementById('odontologoModal'));
	      modal.show();

	    } catch (error) {
	      alert('No se pudo cargar el odontólogo para edición');
	      console.error(error);
	    }
	  }

</script>
<script>
  async function editarOdontologo(id) {
    try {
      const response = await fetch(`/admin/odontologos/api/${id}`);
      if (!response.ok) throw new Error('Error al obtener odontólogo');

      const odontologo = await response.json();

      // Cargar valores en el formulario
      document.querySelector('[name="nombre"]').value = odontologo.usuario.nombre || '';
      document.querySelector('[name="apellido"]').value = odontologo.usuario.apellido || '';
      document.querySelector('[name="dni"]').value = odontologo.usuario.dni || '';
      document.querySelector('[name="correo"]').value = odontologo.usuario.correo || '';
      document.querySelector('[name="telefono"]').value = odontologo.usuario.telefono || '';
      document.querySelector('[name="direccion"]').value = odontologo.usuario.direccion || '';
      document.querySelector('[name="especialidad"]').value = odontologo.especialidad || '';
      document.querySelector('[name="fechaContratacion"]').value = odontologo.fechaContratacion || '';

      // Cambiar acción del formulario
      const form = document.querySelector('#modalOdontologo form');
      form.action = `/admin/odontologos/editar/${id}`;

      // Ocultar campo contraseña (si existe)
      const passField = document.querySelector('div[th\\:if]');
      if (passField) passField.style.display = 'none';

      // Abrir modal
      abrirModal('modalOdontologo');
    } catch (error) {
      alert('No se pudo cargar el odontólogo para edición');
      console.error(error);
    }
  }
</script>

</body>
</html>
