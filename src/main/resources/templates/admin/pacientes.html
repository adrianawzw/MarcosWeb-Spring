<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pacientes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    function abrirModal(id) {
      document.getElementById(id).classList.remove('hidden');
    }
    function cerrarModal(id) {
      document.getElementById(id).classList.add('hidden');
    }
  </script>
  <script>
    async function editarPaciente(id) {
      try {
        const response = await fetch(`/admin/pacientes/api/${id}`);
        if (!response.ok) throw new Error('Error al obtener paciente');

        const paciente = await response.json();

        // Cargar los valores en los inputs del modal
        document.querySelector('[name="nombre"]').value = paciente.usuario.nombre || '';
        document.querySelector('[name="apellido"]').value = paciente.usuario.apellido || '';
        document.querySelector('[name="dni"]').value = paciente.usuario.dni || '';
        document.querySelector('[name="correo"]').value = paciente.usuario.correo || '';
        document.querySelector('[name="telefono"]').value = paciente.usuario.telefono || '';
        document.querySelector('[name="direccion"]').value = paciente.usuario.direccion || '';
        document.querySelector('[name="fechaNacimiento"]').value = paciente.fechaNacimiento || '';
        document.querySelector('[name="historialClinico"]').value = paciente.historialClinico || '';

        // Cambiar acción del formulario para actualizar
        const form = document.querySelector('#modalPaciente form');
        form.action = `/admin/pacientes/editar/${id}`;

        // Ocultamos el campo contraseña al editar
        const passField = document.querySelector('div[th\\:if]');
        if (passField) passField.style.display = 'none';

        // Abrimos el modal
        abrirModal('modalPaciente');
      } catch (error) {
        alert('No se pudo cargar el paciente para edición');
        console.error(error);
      }
    }
  </script>

</head>

<body class="bg-gray-100 p-8">
  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-6">
    <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">Gestión de Pacientes</h1>

	<!-- Botones superiores -->
	<div class="flex justify-between items-center mb-4">
	    <!-- Botón Volver -->
	    <a href="/dashboard"
	       class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2">
	        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
	             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
	            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
	        </svg>
	        Volver al Dashboard
	    </a>

	    <!-- Botón Nuevo Paciente -->
	    <button onclick="abrirModal('modalPaciente')" 
	            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
	        Nuevo Paciente
	    </button>
	</div>

    <!-- Tabla de pacientes -->
    <table class="min-w-full border border-gray-300 rounded-lg overflow-hidden">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th class="p-2 text-left">ID</th>
          <th class="p-2 text-left">Nombre</th>
          <th class="p-2 text-left">Correo</th>
          <th class="p-2 text-left">DNI</th>
          <th class="p-2 text-left">Teléfono</th>
          <th class="p-2 text-left">Fecha Nacimiento</th>
          <th class="p-2 text-left">Historial Clínico</th>
          <th class="p-2 text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="paciente : ${pacientes}" class="border-b hover:bg-gray-100">
          <td class="p-2" th:text="${paciente.idPaciente}"></td>
          <td class="p-2" th:text="${paciente.usuario.nombre + ' ' + paciente.usuario.apellido}"></td>
          <td class="p-2" th:text="${paciente.usuario.correo}"></td>
          <td class="p-2" th:text="${paciente.usuario.dni}"></td>
          <td class="p-2" th:text="${paciente.usuario.telefono}"></td>
          <td class="p-2" th:text="${paciente.fechaNacimiento}"></td>
          <td class="p-2" th:text="${paciente.historialClinico}"></td>
          <td class="p-2 text-center space-x-2">
			<button type="button"
			        class="text-blue-500 hover:underline"
			        th:onclick="'editarPaciente(' + ${paciente.idPaciente} + ')'">
			  Editar
			</button>
            <a th:href="@{/admin/pacientes/eliminar/{id}(id=${paciente.idPaciente})}" 
               class="text-red-500 hover:underline"
               onclick="return confirm('¿Seguro que deseas eliminar este paciente?')">Eliminar</a>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- MODAL NUEVO/EDITAR PACIENTE -->
  <div id="modalPaciente" 
       class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl p-6">
      <h2 class="text-xl font-semibold text-center text-blue-600 mb-4"
          th:text="${paciente.idPaciente != null} ? 'Editar Paciente' : 'Nuevo Paciente'"></h2>

      <form th:action="@{/admin/pacientes/guardar}" method="post" class="space-y-3">

        <!-- CAMPOS USUARIO -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block font-semibold">Nombre:</label>
            <input type="text" name="nombre" th:value="${paciente.usuario != null ? paciente.usuario.nombre : ''}" required
                   class="w-full border border-gray-300 rounded-lg p-2">
          </div>
          <div>
            <label class="block font-semibold">Apellido:</label>
            <input type="text" name="apellido" th:value="${paciente.usuario != null ? paciente.usuario.apellido : ''}" required
                   class="w-full border border-gray-300 rounded-lg p-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block font-semibold">DNI:</label>
            <input type="text" name="dni" th:value="${paciente.usuario != null ? paciente.usuario.dni : ''}" required
                   class="w-full border border-gray-300 rounded-lg p-2">
          </div>
          <div>
            <label class="block font-semibold">Correo:</label>
            <input type="email" name="correo" th:value="${paciente.usuario != null ? paciente.usuario.correo : ''}" required
                   class="w-full border border-gray-300 rounded-lg p-2">
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block font-semibold">Teléfono:</label>
            <input type="text" name="telefono" th:value="${paciente.usuario != null ? paciente.usuario.telefono : ''}"
                   class="w-full border border-gray-300 rounded-lg p-2">
          </div>
          <div>
            <label class="block font-semibold">Dirección:</label>
            <input type="text" name="direccion" th:value="${paciente.usuario != null ? paciente.usuario.direccion : ''}"
                   class="w-full border border-gray-300 rounded-lg p-2">
          </div>
        </div>

        <!-- Solo mostrar contraseña si es nuevo -->
        <div th:if="${paciente.idPaciente == null}">
          <label class="block font-semibold">Contraseña:</label>
          <input type="password" name="password" required
                 class="w-full border border-gray-300 rounded-lg p-2">
        </div>

        <!-- CAMPOS PACIENTE -->
        <div class="grid grid-cols-2 gap-3 mt-4">
          <div>
            <label class="block font-semibold">Fecha de Nacimiento:</label>
            <input type="date" name="fechaNacimiento" th:value="${paciente.fechaNacimiento}"
                   class="w-full border border-gray-300 rounded-lg p-2">
          </div>
          <div>
            <label class="block font-semibold">Historial Clínico:</label>
            <textarea name="historialClinico"
                      class="w-full border border-gray-300 rounded-lg p-2"
                      th:text="${paciente.historialClinico}"></textarea>
          </div>
        </div>

        <div class="flex justify-between mt-6">
          <button type="button" onclick="cerrarModal('modalPaciente')"
                  class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
            Cancelar
          </button>
          <button type="submit"
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Guardar
          </button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
